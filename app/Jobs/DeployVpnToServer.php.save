<?php

namespace App\Jobs;

use App\Models\VpnServer;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Symfony\Component\Process\Process;
use Symfony\Component\Process\Exception\ProcessFailedException;

class DeployVpnToServer implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    protected $server;

    public function __construct(VpnServer $server)
    {
        $this->server = $server;
    }

    public function handle(): void
    {
        $server = $this->server;
        $server->update([
            'deployment_status' => 'running',
            'deployment_log' => 'Starting deployment...'
        ]);

        try {
            $script = $server->protocol === 'wireguard'
                ? '/var/www/scripts/install-wireguard.sh'
                : '/var/www/scripts/install-openvpn.sh';

            $process = Process::fromShellCommandline(
                "ssh -o StrictHostKeyChecking=no -i /var/www/aiovpn/storage/ssh/id_rsa root@{$server->ip} 'bash -s' < {$script}"
            );

            $process->setTimeout(600);
            $process->run(function ($type, $buffer) use ($server) {
                $server->refresh();
                $server->update([
                    'deployment_log' => $server->deployment_log . "\n" . trim($buffer)
                ]);
            });

            if (!$process->isSuccessful()) {
                throw new ProcessFailedException($process);
            }

            $server->update([
                'deployment_status' => 'success',
                'deployment_log' => $server->deployment_log . "\nâœ… Deployment completed successfully."
            ]);

        } catch (\Exception $e) {
            $server->update([
                'deployment_status' => 'failed',
                'deployment_log' => $server->deployment_log . "\nâŒ Error: " . $e->getMessage()
            ]);
        }
    }
}
