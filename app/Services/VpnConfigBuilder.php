<?php

namespace App\Services;

use App\Models\VpnUser;
use App\Models\VpnServer;
use App\Traits\ExecutesRemoteCommands;
use Exception;
use Illuminate\Support\Facades\Log;

class VpnConfigBuilder
{
    use ExecutesRemoteCommands;

    private const DEFAULT_OVPN_PORT = 1194;

    /**
     * Generate an OpenVPN config string for a user + server.
     */
    public static function generateOpenVpnConfigString(VpnUser $vpnUser, VpnServer $server): string
    {
        $inst = new static();

        // Always fetch certs directly from the server
        [$caCert, $tlsKey] = $inst->fetchCertificatesFromServer($server);

        if ($caCert === '' || $tlsKey === '') {
            throw new Exception("❌ Missing certificates for server {$server->name} ({$server->id})");
        }

        $remote = "{$server->ip_address} " . self::DEFAULT_OVPN_PORT;

        // Embed username/password if plain_password exists, otherwise prompt
        $plain = trim((string)($vpnUser->plain_password ?? ''));
        $userpassBlock = $plain !== ''
            ? <<<TXT
# Embedded user-pass
<auth-user-pass>
{$vpnUser->username}
{$plain}
</auth-user-pass>
TXT
            : 'auth-user-pass';

        $cfg = <<<OVPN
# Auto-generated by AIOVPN
client
dev tun
proto udp
remote {$remote}
nobind
persist-key
persist-tun
remote-cert-tls server
auth SHA256
cipher AES-256-GCM
ncp-ciphers AES-256-GCM:AES-128-GCM
verb 3

<ca>
{$caCert}
</ca>

<tls-auth>
{$tlsKey}
</tls-auth>
key-direction 1

{$userpassBlock}
OVPN;

        Log::info("✅ Built OVPN config", [
            'user' => $vpnUser->username,
            'server' => $server->name,
            'ip' => $server->ip_address,
        ]);

        return $cfg;
    }

    /**
     * Fetch CA + TLS keys from the VPN server over SSH.
     * @return array{0:string,1:string}
     */
    private function fetchCertificatesFromServer(VpnServer $server): array
    {
        $result = ['', ''];

        try {
            $ca = $this->executeRemoteCommand($server, 'cat /etc/openvpn/ca.crt');
            if ($ca['status'] === 0 && !empty($ca['output'])) {
                $result[0] = trim(implode("\n", $ca['output']));
            }

            $ta = $this->executeRemoteCommand($server, 'cat /etc/openvpn/ta.key');
            if ($ta['status'] === 0 && !empty($ta['output'])) {
                $result[1] = trim(implode("\n", $ta['output']));
            }

            Log::info("✅ Fetched certs from server", [
                'server' => $server->name,
                'ip' => $server->ip_address,
                'has_ca' => $result[0] !== '',
                'has_ta' => $result[1] !== '',
            ]);
        } catch (Exception $e) {
            Log::error("❌ Failed fetching certs", [
                'server' => $server->name,
                'ip' => $server->ip_address,
                'error' => $e->getMessage(),
            ]);
        }

        return $result;
    }
}